---
title: ã€Šæ ‘è“æ´¾å®¶åº­æœåŠ¡å™¨æ­å»ºæŒ‡å—ã€‹ç¬¬åå››æœŸï¼šä½¿ç”¨æ ‘è“æ´¾4Bæ­å»ºk8sé›†ç¾¤ / ã€ŠUse Piã€‹ Issue 14 Building a k8s Cluster Using Raspberry Pi 4B
categories:
- æ ‘è“æ´¾ä¸åƒç° / Use Pi
---


k8sæ˜¯è°·æ­Œæ¨å‡ºä¸€æ¬¾æœåŠ¡å™¨é›†ç¾¤ç®¡ç†å·¥å…·, å¼€æºå…è´¹, åŠŸèƒ½å¼ºå¤§, å¯ä»¥åˆ›é€ ä¸€ä¸ªäººç®¡ç†æœåŠ¡å™¨é›†ç¾¤çš„å¥‡è¿¹ã€‚

ğŸŒˆk8s is a server cluster management tool launched by Google, which is open-source, free, and powerful. It can create a miracle of one person managing a server cluster.


k8s é€šç”¨å‹æå¼ºï¼Œæ˜¯ä¸€å¥—æ ‡å‡†çš„è¿ç»´ç­–ç•¥ï¼Œåªè¦ç¨‹åºéƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼Œå°±è¦è€ƒè™‘ç¨‹åºç¨³å®šæ€§çš„é—®é¢˜ï¼Œè€Œk8sçš„å¼¹æ€§æ‰©å®¹ï¼Œä»¥åŠå¤šä¸»æœºç›¸äº’å¤‡ä»½ç­–ç•¥ï¼Œå³ä½¿éƒ¨åˆ†æœåŠ¡å™¨ç‰©ç†å®•æœºï¼Œè¢«é»‘å®¢DDOSæ”»å‡»ï¼Œä¹Ÿèƒ½é€šè¿‡å†…ç½®ç­–ç•¥è‡ªåŠ¨è¿›è¡Œåº”å¯¹ã€‚

ğŸŒˆk8s is highly versatile and is a standard operation and maintenance strategy. As long as the program is deployed to the server, the stability of the program must be considered. With the elastic expansion of k8s and the mutual backup strategy of multiple hosts, even if some servers physically crash or are attacked by hackers with DDOS, they can automatically respond through built-in strategies.


k8sç”±è°·æ­Œå¼€æºï¼Œè€Œä¸”è°·æ­Œè‡ªå®¶ä¹Ÿåœ¨ç”¨è¿™å¥—æ–¹æ¡ˆï¼Œæˆ‘ä»¬èƒ½å…è´¹è·å¾—æŒç»­ç¨³å®šçš„æŠ€æœ¯æ”¯æŒå’Œç‰ˆæœ¬è¿­ä»£ã€‚

ğŸŒˆk8s is open-sourced by Google, and Google itself also uses this solution. We can get continuous and stable technical support and version iterations for free.


k8sæ˜¯ä¸€å¥—å•†ä¸šçº§çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼Œå¦‚æœæƒ³è¦è¸å…¥ä¸“ä¸šçš„è¿ç»´é¢†åŸŸ, è·å¾—ä¸€ä»½ç³Šå£çš„è¿ç»´å·¥ä½œ, ä¹Ÿè¦ç†Ÿæ‚‰k8sè¿™å¥—å ªç§°ä¸šç•Œæ ‡æ†çš„å·¥å…·ã€‚

ğŸŒˆk8s is a complete commercial-level solution. If you want to step into the professional operation and maintenance field and get a job that can make a living, you also need to be familiar with k8s, which can be called a benchmark tool in the industry.


è¿™ç¯‡åšå®¢è®°å½•zhaooleeä½¿ç”¨æ ‘è“æ´¾å»ºç«‹k8sé›†ç¾¤çš„å…¨è¿‡ç¨‹ï¼Œå¦‚æœä½ å¯¹æ ‘è“æ´¾k8sé›†ç¾¤æ„Ÿå…´è¶£ï¼Œè¿™ç¯‡åšå®¢ä¼šç»™ä½ å¾ˆå¤šå¸®åŠ©ã€‚

ğŸŒˆThis blog records the whole process of zhaoolee using Raspberry Pi to build a k8s cluster. If you are interested in the Raspberry Pi k8s cluster, this blog will be of great help to you.


é¦–å…ˆï¼Œå°†æ ‘è“æ´¾è¿æ¥åˆ°åŒä¸€ä¸ªå±€åŸŸç½‘ç¯å¢ƒä¸‹, ä¸ºäº†ä¿è¯ç¨³å®šæ€§ï¼Œæœ€å¥½å°†è·¯ç”±å™¨ä¸æ ‘è“æ´¾é€šè¿‡ç½‘çº¿ç›¸è¿ï¼Œä¸ºäº†é¿å¼€ä¹±ä¸ƒå…«ç³Ÿçš„ä¾èµ–åŒ…ä¸‹è½½é—®é¢˜ï¼Œè·¯ç”±å™¨éœ€è¦æ”¯æŒç§‘å­¦ä¸Šç½‘~

ğŸŒˆFirst, connect the Raspberry Pi to the same LAN environment. To ensure stability, it is best to connect the router and the Raspberry Pi through a network cable. To avoid the mess of dependency package download problems, the router needs to support scientific Internet access~


æœ¬æ–‡ä½¿ç”¨çš„ä¸‰å°æ ‘è“æ´¾4Bå‡ä¸º8GBç‰ˆæœ¬ï¼Œé•œåƒé€‰çš„æ˜¯Ubuntu20.04, å¦‚æœå¯¹æ ‘è“æ´¾åˆ·é•œåƒæœ‰ç–‘é—®ï¼Œå¯ä»¥ç‚¹å‡»å¾€æœŸ [ã€Šæ ‘è“æ´¾å®¶åº­æœåŠ¡å™¨æ­å»ºæŒ‡å—ã€‹åˆ·Ubuntu Server 20.04ï¼Œç»‘å®šå…¬ç½‘åŸŸåï¼Œå¯¹å…¬ç½‘æä¾›httpæœåŠ¡ï¼ŒSSHç™»å½•æœåŠ¡ https://v2fy.com/p/2021-10-01-pi-server-1633066843000/](https://v2fy.com/p/2021-10-01-pi-server-1633066843000/)

ğŸŒˆThe three Raspberry Pi 4Bs used in this article are all 8GB versions, and the selected image is Ubuntu20.04. If you have any questions about flashing the Raspberry Pi image, you can click on the previous [ã€ŠRaspberry Pi Home Server Building Guideã€‹Issue 21: Flashing Ubuntu Server 20.04, binding a public domain name, providing http service to the public network, SSH login service](https://v2fy.com/p/2021-10-01-pi-server-1633066843000/)


æœ¬æ–‡å®‰è£…çš„K8sç‰ˆæœ¬ä¸ºv1.23.1

ğŸŒˆThe version of K8s installed in this article is v1.23.1

## é¦–å…ˆä¸‰å°æ ‘è“æ´¾è¿è¡Œçš„ubuntu20.04ï¼Œå®‰è£…ç½‘ç»œå·¥å…·åŒ…
```
sudo apt install net-tools -y
```

## ä¸ºä¸‰å°æ ‘è“æ´¾è®¾ç½®å›ºå®šçš„ip

å¯ä»¥åœ¨è·¯ç”±å™¨Webç«¯é€šè¿‡**æ ‘è“æ´¾macåœ°å€ä¸ipè¿›è¡Œç»‘å®š**å®Œæˆè®¾ç½®

![macåœ°å€ä¸ipè¿›è¡Œç»‘å®š](https://cdn.fangyuanxiaozhan.com/assets/1641393776473aXXap1DB.png)

ä¹Ÿå¯ä»¥é€šè¿‡æ ‘è“æ´¾ç›´æ¥è®¾ç½®é™æ€ipï¼Œ å‚è€ƒæ•™ç¨‹ [ä¸ºUbuntu 20.04 è®¾ç½®é™æ€IPç®€æ˜æ•™ç¨‹ï¼ˆå’ŒæŠŠå¤§è±¡è£…å†°ç®±ä¸€æ ·ç®€å•ï¼‰https://v2fy.com/p/2022-01-01-ip-1641016585000/](https://v2fy.com/p/2022-01-01-ip-1641016585000/)

## é€šè¿‡ hostnamectl è®¾ç½®ä¸»æœºå

æˆ‘çš„è·¯ç”±å™¨ä¸ºä¸‰å°æ ‘è“æ´¾åˆ†åˆ«åˆ†é…äº†`192.168.50.10`, `192.168.50.20`, `192.168.50.30`, åé¢çš„å†…å®¹ä¹Ÿä¼šåå¤æåˆ°è¿™å‡ ä¸ªip,å¦‚æœä½ çš„ipä¸æˆ‘ä¸åŒï¼Œè¯·è‡ªè¡Œæ›¿æ¢å³å¯ã€‚

åœ¨ipä¸º`192.168.50.10`çš„ masterä¸»æœºæ‰§è¡Œ

```
hostnamectl set-hostname master
```
![æ‰§è¡Œhostnamectl set-hostname](https://cdn.fangyuanxiaozhan.com/assets/16413937764640hbnb7Ws.png)

åœ¨ipä¸º`192.168.50.20`çš„ node1ä¸»æœºæ‰§è¡Œ
```
hostnamectl set-hostname node1
```
åœ¨ipä¸º`192.168.50.30`çš„ node2ä¸»æœºæ‰§è¡Œ
```
hostnamectl set-hostname node2
```
è®¾ç½®å®Œæˆåï¼Œå¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æœ¬æœºä¿¡æ¯

```
hostnamectl status
```

![æœ¬æœºä¿¡æ¯](https://cdn.fangyuanxiaozhan.com/assets/1641393776455fiFxRtkd.png)


å¦‚æœä½ çš„shellç»ˆç«¯æ˜¾ç¤ºä¸»æœºåï¼Œåˆ™å¯ä»¥é€šè¿‡ä¸»æœºåè¿›è¡Œæ–¹ä¾¿çš„åŒºåˆ†

![ä¸»æœºååŒºåˆ†](https://cdn.fangyuanxiaozhan.com/assets/1641393776469fKSynTTW.png)


## ä¿®æ”¹hostå¹¶åˆ›å»ºåˆ«å

åœ¨ä¸‰å°æ ‘è“æ´¾çš„`/etc/hosts`å†…æ·»åŠ ä»¥ä¸‹é…ç½®

```
192.168.50.10 master
192.168.50.20 node1
192.168.50.30 node2
```

Ubuntu20.04 å·²ç»æ”¾å¼ƒçš„SELinuxï¼Œæ‰€ä»¥å…³äºSELinuxçš„è®¾ç½®ï¼Œæˆ‘ä»¬æ— éœ€å¤„ç†

K8s V1.22ç‰ˆæœ¬å¼€å§‹å·²ç»æ”¯æŒä½¿ç”¨swapï¼Œæˆ‘ä»¬ä¹Ÿæ— éœ€å…³é—­swapå†…å­˜

## ä¸ºäº†ä¿è¯masterä¸nodeä¹‹é—´çš„é€šä¿¡ï¼Œæˆ‘ä»¬éœ€è¦å…³é—­æ ‘è“æ´¾é˜²ç«å¢™


ufwï¼Œæˆ–ç§°Uncomplicated Firewallï¼Œæ˜¯iptablesçš„ä¸€ä¸ªæ¥å£ï¼Œä¸ºä¸ç†Ÿæ‚‰é˜²ç«å¢™æ¦‚å¿µçš„åˆå­¦è€…æä¾›äº†æ˜“äºä½¿ç”¨çš„ç•Œé¢ï¼ŒåŒæ—¶æ”¯æŒIPv4å’ŒIPv6ï¼Œå¹¿å—æ¬¢è¿ã€‚Ubuntu20.04 é»˜è®¤å®‰è£…äº†é˜²ç«å¢™ç®¡ç†å·¥å…·ufwï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸‰å°æ ‘è“æ´¾æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå…³é—­é˜²ç«å¢™ã€‚

```
# å…³é—­é˜²ç«å¢™
sudo ufw disable
# æ£€æµ‹é˜²ç«å¢™çŠ¶æ€
sudo ufw status
```

![å…³é—­é˜²ç«å¢™](https://cdn.fangyuanxiaozhan.com/assets/16413937765156F6mX4aG.png)

æ ‘è“æ´¾ä¸€èˆ¬åœ¨å†…ç½‘ï¼Œä¸å®¹æ˜“é­å—æ”»å‡»ï¼Œå¦‚æœæ˜¯å¤–ç½‘çš„æœºå™¨ï¼Œå»ºè®®è¿˜æ˜¯åªå¼€æ”¾å¿…è¦çš„ç«¯å£

éœ€è¦å¼€æ”¾ç«¯å£çš„å‚è€ƒèµ„æ–™ï¼šhttps://kubernetes.io/docs/reference/ports-and-protocols/

## å®‰è£…Docker

ä¸‰å°æ ‘è“æ´¾å„è‡ªè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå®ŒæˆDockerçš„å®‰è£…

```
sudo apt update

sudo apt install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg \
    lsb-release -y

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt update

sudo apt install docker-ce=5:20.10.8~3-0~ubuntu-focal docker-ce-cli=5:20.10.9~3-0~ubuntu-focal containerd.io=1.4.11-1 -y

docker -v
```

![docker](https://cdn.fangyuanxiaozhan.com/assets/1641393776552f0EzHyxB.png)


## å®‰è£…k8s

- åœ¨ä¸‰å°æ ‘è“æ´¾ å®‰è£… kubectl kubelet kubeadm


```
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl

sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg


echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list


sudo apt-get update
sudo apt-get install -y kubectl kubelet kubeadm


```


- æŸ¥çœ‹kubectlæ˜¯å¦å®‰è£…æˆåŠŸ

```
kubectl version --client
```

![æ£€æµ‹kubectl](https://cdn.fangyuanxiaozhan.com/assets/1641393776575Z5WhZXQn.png)

- æŸ¥çœ‹kubeletæ˜¯å¦å®‰è£…æˆåŠŸ

```
kubelet --version
```

![æ£€æµ‹kubelet](https://cdn.fangyuanxiaozhan.com/assets/1641393776698xGXYBeDF.png)

- æŸ¥çœ‹kubeadmæ˜¯å¦å®‰è£…æˆåŠŸ

```
kubeadm version
```

![æ£€æµ‹kubeadm](https://cdn.fangyuanxiaozhan.com/assets/1641393776753sWQxbssb.png)


## åœ¨ä¸‰å°æ ‘è“æ´¾ è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä¿è¯kubeletå’Œdockerå¯åŠ¨ï¼Œå¹¶è®¾ç½®å¼€æœºå¯åŠ¨

```
sudo systemctl enable kubelet
sudo systemctl start kubelet
sudo systemctl enable docker
sudo systemctl start docker
```


## ä¿®æ”¹docker é…ç½®


```
sudo chmod 777 -R /opt/
cd /opt
# kubernetes å®˜æ–¹æ¨è docker ç­‰ä½¿ç”¨ systemd ä½œä¸º cgroupdriverï¼Œå¦åˆ™ kubelet å¯åŠ¨ä¸äº†
cat <<EOF > daemon.json
{
  "exec-opts": ["native.cgroupdriver=systemd"]
}
EOF
sudo mv daemon.json /etc/docker/

# é‡å¯ç”Ÿæ•ˆ
sudo systemctl daemon-reload
sudo systemctl restart docker
```
## ä¿®æ”¹æ ‘è“æ´¾çš„é…ç½®ï¼Œå¹¶é‡å¯

```
sudo vim /boot/firmware/cmdline.txt
```

![æ–°å¢ä¿®æ”¹](https://cdn.fangyuanxiaozhan.com/assets/164139377680245wcPFyD.png)

```
cgroup_enable=memory cgroup_memory=1
```

ä¿®æ”¹å®Œæˆå,é‡å¯æ ‘è“æ´¾

```
reboot
```


## åœ¨masterèŠ‚ç‚¹åˆå§‹åŒ–é›†ç¾¤


```
sudo kubeadm init --pod-network-cidr=10.244.0.0/16
```

> æ³¨æ„è¿™é‡Œè¦è¿½åŠ `--pod-network-cidr=10.244.0.0/16`å‚æ•°

![è·å¾—tokenæ–‡æœ¬](https://cdn.fangyuanxiaozhan.com/assets/1641393777034NYFESb5G.png)

æœ€åçš„tokenæ–‡æœ¬è¦å¥½å¥½ä¿å­˜èµ·æ¥ï¼Œå­èŠ‚ç‚¹åŠ å…¥masterè¦ç”¨åˆ°
```
kubeadm join 192.168.50.10:6443 --token tn3*********9f7  --discovery-token-ca-cert-hash sha256:3862***46739303********94
```

- å°†kubeadmæˆæƒæ–‡ä»¶å¤åˆ¶åˆ°ç”¨æˆ·æ ¹ç›®å½•ï¼Œä»¥ä¾¿kubectl å¯ä»¥æœ‰æƒé™è®¿é—®é›†ç¾¤

```
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

æœ€ç»ˆæˆæƒæ–‡ä»¶çš„å†…å®¹ï¼Œå¦‚ä¸‹å›¾çš„æ ¼å¼

![æˆæƒæ–‡ä»¶](https://cdn.fangyuanxiaozhan.com/assets/1641393777124ZHKQ4MZE.png)


- åœ¨masterèŠ‚ç‚¹å®‰è£…ä¸€ä¸ªç½‘ç»œæ’ä»¶ï¼Œæ–¹ä¾¿nodeèŠ‚ç‚¹åç»­è¿æ¥é€šä¿¡

```
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```

- å®‰è£…æ’ä»¶åï¼Œç­‰å¾…å„èŠ‚ç‚¹Ready
```
kuberctl get nodes
```

![å®‰è£…ç½‘ç»œæ’ä»¶ï¼Œç­‰å¾…masterèŠ‚ç‚¹Ready](https://cdn.fangyuanxiaozhan.com/assets/1641393777259xTJdYSTE.png)


## åœ¨node1å’Œnode2è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°†node1å’Œnode2åŠ å…¥åˆ°masterèŠ‚ç‚¹


```
sudo kubeadm join 192.168.50.10:6443 --token tn3*********9f7  --discovery-token-ca-cert-hash sha256:3862***46739303********94
```

ä»¥ä¸Šå‘½ä»¤ä¸­çš„tokenå‚æ•°ï¼Œéƒ½ç”±masterèŠ‚ç‚¹,è¿è¡Œ sudo kubeadm init æ—¶äº§ç”Ÿï¼Œå¦‚æœå¿˜è®°äº†å¯ä»¥é€šè¿‡åœ¨masterèŠ‚ç‚¹è¿è¡Œ`sudo kubeadm token create --print-join-command` é‡æ–°è·å–

- åœ¨masterèŠ‚ç‚¹è¿è¡Œkubectl get nodes æŸ¥çœ‹å„èŠ‚ç‚¹çŠ¶æ€ï¼Œå½“æ‰€æœ‰èŠ‚ç‚¹Ready, å³å¤§åŠŸå‘Šæˆï¼

![](https://cdn.fangyuanxiaozhan.com/assets/16413937773940cPRebFP.png)




## å®‰è£…Kuboard

```
mkdir ~/kuboard-data
sudo docker run -d --restart=unless-stopped --name=kuboard -p 30080:80/tcp -p 10081:10081/tcp -e KUBOARD_ENDPOINT="http://192.168.50.10:30080" -e KUBOARD_AGENT_SERVER_TCP_PORT="10081" -v ~/kuboard-data:/data eipwork/kuboard:v3
```

è®¿é—® http://192.168.50.10:30080 å³å¯è®¿é—®åˆ°Kuboard

ç™»å½•ç”¨æˆ·åï¼š `admin`
ç™»å½•å¯†ç ï¼š `Kuboard123`

![Kuboard](https://cdn.fangyuanxiaozhan.com/assets/1641393777591E2Bt8mwC.png)


- æ·»åŠ é›†ç¾¤

![æ·»åŠ é›†ç¾¤](https://cdn.fangyuanxiaozhan.com/assets/1641393777813fAS2Jkah.png)


- é€‰æ‹©.kubeconfigæ–¹å¼å¯¼å…¥é›†ç¾¤


![å¯¼å…¥é›†ç¾¤](https://cdn.fangyuanxiaozhan.com/assets/1641393778019FK8eyhBR.png)

- è·å– ~/.kube/configä¿¡æ¯

```
cat ~/.kube/config
```

å°†~/.kube/configçš„æ–‡æœ¬ä¿¡æ¯è´´å…¥é¡µé¢

![å¯¼å…¥é›†ç¾¤](https://cdn.fangyuanxiaozhan.com/assets/1641393778172bdaFHw81.png)

å¯¼å…¥æˆåŠŸ

![å¯¼å…¥æˆåŠŸ](https://cdn.fangyuanxiaozhan.com/assets/1641393778319thTEPNxa.png)

æ‰€æœ‰namespaceå’ŒèŠ‚ç‚¹ä¿¡æ¯å°½æ”¶çœ¼åº•

![ä¿¡æ¯å°½æ”¶çœ¼åº•](https://cdn.fangyuanxiaozhan.com/assets/16413937788883RhtA8kN.png)


## åˆ›å»ºservice

![åˆ›å»ºService](https://cdn.fangyuanxiaozhan.com/assets/1641393779087d3732hQ6.png)


```
apiVersion: apps/v1
kind: Deployment
metadata:
  # éƒ¨ç½²åå­—
  name: pi-k8s-test
  namespace: ingress-nginx
spec:
  replicas: 2
  # ç”¨æ¥æŸ¥æ‰¾å…³è”çš„ Podï¼Œæ‰€æœ‰æ ‡ç­¾éƒ½åŒ¹é…æ‰è¡Œ
  selector:
    matchLabels:
      app: pi-k8s-test
  # å®šä¹‰ Pod ç›¸å…³æ•°æ®
  template:
    metadata:
      labels:
        app: pi-k8s-test
    spec:
      # å®šä¹‰å®¹å™¨ï¼Œå¯ä»¥å¤šä¸ª
      containers:
      - name: pi-k8s-test # å®¹å™¨åå­—
        image: zhaoolee/pi-k8s-test:001 # é•œåƒ

---
apiVersion: v1
kind: Service
metadata:
  name: pi-k8s-test
  namespace: ingress-nginx
spec:
  selector:
    app: pi-k8s-test
  type: NodePort
  ports:
    - port: 3000        # æœ¬ Service çš„ç«¯å£
      targetPort: 3000  # å®¹å™¨ç«¯å£
```

ä»ä¸Šé¢çš„yamlæ–‡æœ¬ä¸­ï¼Œå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ä½¿ç”¨é•œåƒzhaoolee/pi-k8s-test:001ï¼Œ æ–°å»ºäº†ä¸¤ä¸ªpodï¼ˆpodå¯ä»¥å®¹çº³Nä¸ªé•œåƒè¿è¡Œäº§ç”Ÿçš„å®¹å™¨ï¼‰ï¼Œè¿™ä¸¤ä¸ªpodä¼šè¢«k8sè‡ªåŠ¨è°ƒåº¦åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œnode1å’Œnode2å„ä¸€ä¸ª

![ä¸åŒèŠ‚ç‚¹](https://cdn.fangyuanxiaozhan.com/assets/1641393779247ABJaxaAC.png)

è€Œyamlæ–‡ä»¶çš„ä¸‹åŠéƒ¨åˆ†ï¼Œåˆ™åˆ›å»ºäº†ä¸€ä¸ªæœåŠ¡serviceï¼Œè¿™ä¸ªæœåŠ¡æ˜¯podçš„çˆ¶çº§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡serviceæš´éœ²çš„3000ç«¯å£æ¥è®¿é—®podï¼Œserviceä¹Ÿå°±æ˜¯ä¸€ä¸ªåŸå­åŒ–çš„æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¤§é‡çš„service, æ¥åº”å¯¹ä¸åŒçš„åœºæ™¯

ä½†å¤§é‡çš„serviceç®¡ç†èµ·æ¥å¾ˆéº»çƒ¦ï¼Œå ç”¨çš„ç«¯å£ä¹Ÿå¾ˆæ‚ä¹±ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç±»ä¼¼Nginxçš„ç½‘å…³ï¼Œæ¥ç»Ÿä¸€æ¥æ”¶å¤–éƒ¨è¯·æ±‚ï¼Œç„¶åé€šè¿‡åœ¨Nginxè®¾ç½®å¥½çš„è§„åˆ™ï¼Œå°†è¯·æ±‚åˆ†å‘åˆ°å¯¹åº”çš„serviceï¼Œ è¿™ä¸ªç±»ä¼¼Nginxçš„éƒ¨åˆ†ï¼Œåœ¨k8sä¸­è¢«ç§°ä¸ºingress, è€Œingressæ°å¥½æœ‰ä¸€ä¸ªåŸºäºnginxå¼€å‘çš„ç‰ˆæœ¬ï¼Œè¢«ç§°ä¸ºNGINX Ingress Controller,ä¸‹é¢æˆ‘å°†å¼€å§‹é…ç½®å®‰è£…NGINX Ingress Controller

## å®‰è£…helm

```
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
```

è¿™ä¸ªhelmå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æ–¹ä¾¿çš„å®‰è£…NGINX Ingress Controllerï¼Œ ä»¥åŠåç»­ç™½å«–å¾ˆå¤šåˆ«äººç°æˆçš„æœåŠ¡é…ç½®ã€‚

## å®‰è£…NGINX Ingress Controller

```
helm upgrade --install ingress-nginx ingress-nginx --repo https://kubernetes.github.io/ingress-nginx  --namespace ingress-nginx --create-namespace
```

å‚è€ƒåœ°å€ https://kubernetes.github.io/ingress-nginx/deploy/#quick-start

ä¸nginxç±»å‹ï¼ŒNGINX Ingress Controlleréœ€è¦é…ç½®è§„åˆ™æ‰èƒ½æŒ‰ç…§æˆ‘ä»¬çš„éœ€æ±‚è½¬å‘è¯·æ±‚ï¼Œä¸‹é¢æˆ‘ä»¬é…ç½®ä¸€ä¸ªç®€å•è§„åˆ™ã€‚

## ä¸ºingressæ·»åŠ è§„åˆ™

```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress
  namespace: ingress-nginx
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          - backend:
              service:
                name: pi-k8s-test
                port:
                  number: 3000
            path: /
            pathType: ImplementationSpecific
```

ä¸Šé¢çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡kuboardç›´æ¥åœ¨é¡µé¢ä¸Šï¼Œé€šè¿‡ä»YAMLåˆ›å»ºå‡ºæ¥ï¼Œå®ƒé…ç½®çš„è§„åˆ™å°±æ˜¯ï¼ŒæŠŠæŒ‡å‘æ ¹è·¯å¾„`/`çš„è¯·æ±‚ï¼Œç»Ÿç»Ÿå‘é€åˆ°pi-k8s-testæœåŠ¡çš„3000ç«¯å£ã€‚

å¦‚æœæŠ¥é”™Internal error occurred: failed calling webhook â€œvalidate.nginx.ingress.kubernetes.io, åˆ™

```
kubectl get validatingwebhookconfigurations
kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission
```

è™½ç„¶ingressä¹Ÿæ˜¯ä¸ªæœåŠ¡ï¼Œä½†ingressè¿™ä¸ªæœåŠ¡æ¯”è¾ƒç‰¹åˆ«ï¼Œå®ƒéœ€è¦è·å¾—å’Œæ ‘è“æ´¾çº§åˆ«çš„ipæ‰èƒ½è¿è¡Œ(ç±»ä¼¼`192.168.50.*`è¿™ç§æ ¼å¼)ï¼Œingressè¢«ç§°ä¸ºloadbalancerç±»å‹çš„æœåŠ¡ã€‚

ä½†k8s æœ¬ä½“ä¸æä¾›å¯¹ loadbalancerç±»å‹çš„æ”¯æŒï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±é¢å¤–å»å®‰è£…ä¸€ä¸ªåä¸ºmetallbçš„å¼€æºè½¯ä»¶ï¼Œè·å¾—k8så¯¹loadbalancerç±»å‹æ”¯æŒã€‚å¦‚æœæˆ‘ä»¬ä¸å®‰è£…metallbï¼Œloadbalancerç±»å‹çš„æœåŠ¡ï¼Œåªèƒ½ä¸€ç›´ä¿æŒåœ¨pendingçš„çŠ¶æ€ã€‚


##  å®‰è£…metallb


é¦–å…ˆå¼€å¯strictARPé€‰é¡¹

```
kubectl edit configmap -n kube-system kube-proxy
```

è¾“å…¥ä»¥ä¸Šå‘½ä»¤åï¼Œä¼šè¿›å…¥vimç¼–è¾‘å™¨æ¨¡å¼ï¼Œæˆ‘ä»¬å°†é…ç½®ä¸­çš„`strictARP: false` æ”¹ä¸º `strictARP: true`

```
strictARP: true
```

- åˆ›å»ºmetallbä¸“ç”¨çš„namespace

```
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/namespace.yaml
```
- éƒ¨ç½²metallb

```
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/metallb.yaml
```

- åˆ›å»ºmemberlist secretï¼Œ è¿™ä¸ªsecretæ˜¯ç”¨æ¥åŠ å¯†speakerä¹‹é—´çš„é€šä¿¡

```
kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey="$(openssl rand -base64 128)"
```

- é€šè¿‡kuboard åˆ›å»ºConfigMap

![å¯¼å…¥](https://cdn.fangyuanxiaozhan.com/assets/16413937794445sA65aGA.png)


```
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
data:
  config: |
    address-pools:
    - name: default
      protocol: layer2
      addresses:
      - 192.168.50.240-192.168.50.250
```

è¿™é‡Œæ³¨æ„æœ€åä¸€è¡Œaddressesé…ç½®ï¼Œæˆ‘æ ‘è“æ´¾ä¸Šå±‚çš„è·¯ç”±å™¨æ˜¯`192.160.50.*` æ®µï¼Œæ‰€ä»¥é…ç½®ä¸º`192.168.50.240-192.168.50.250` è¯·æŒ‰ç…§è‡ªå·±è·¯ç”±å™¨çš„é…ç½®ï¼ŒæŒ‰éœ€æ›´æ”¹ã€‚


- æŸ¥çœ‹LoadBalancerç±»å‹çš„ingress-nginx-controller

```
kubectl get svc -A
```
![åˆ†é…åˆ°ip](https://cdn.fangyuanxiaozhan.com/assets/1641393779523QWaAWFEY.png)

`ingress-nginx-controller`è¢«åˆ†é…åˆ°çš„ipä¸º`192.168.50.240`

æˆ‘ä»¬åœ¨å±€åŸŸç½‘çš„ç”µè„‘ä¸­è®¿é—®`http://192.168.50.240`

![è®¿é—®](https://cdn.fangyuanxiaozhan.com/assets/16413937796187rJDCih7.png)

æˆ‘ä»¬è®¿é—®192.168.50.240ï¼Œå°±ç›¸å½“äºè®¿é—®äº†ingress-nginx-controllerï¼Œ è€Œingress-nginx-controllerä¼šæŠŠæˆ‘ä»¬çš„è¯·æ±‚ï¼ŒæŒ‰ç…§è§„åˆ™ï¼Œè½¬å‘åˆ°æˆ‘ä»¬å‰é¢å»ºç«‹çš„serviceä¸­ï¼Œserviceè‡ªåŠ¨å°†è¯·æ±‚è½¬å‘åˆ°ä¸¤ä¸ªPodä¸­è¿›è¡Œåˆ†åˆ«å¤„ç†ï¼Œè€Œå¤šä¸ªPodæœ¬èº«è¿è¡Œåœ¨ä¸åŒçš„nodeèŠ‚ç‚¹ä¸Šï¼ˆä¸åŒæ ‘è“æ´¾ä¸Šï¼‰ï¼Œå³ä½¿æŸä¸ªnodeæŒ‚æ‰ï¼Œä¹Ÿå¯å¯¹å¤–ç¨³å®šæä¾›æœåŠ¡ã€‚

å¦‚æœæˆ‘ä»¬æ”¶åˆ°çš„è¯·æ±‚é‡å˜å¤§ï¼Œæˆ‘ä»¬é€šè¿‡å¢å¤§podæ•°é‡ï¼Œæˆ–å¢åŠ æ›´å¤šæ ‘è“æ´¾ï¼ˆnodeèŠ‚ç‚¹ï¼‰çš„æ–¹å¼ï¼Œå¤„ç†è¯·æ±‚ã€‚


å‚è€ƒèµ„æ–™ï¼šhttps://www.bboy.app/2021/01/11/metallb%E9%83%A8%E7%BD%B2%E4%BD%BF%E7%94%A8/


## å¦‚ä½•å¿«é€Ÿå˜æ›´é•œåƒ?

æˆ‘ä»¬å‰é¢ä½¿ç”¨äº†zhaoolee/pi-k8s-test:001é•œåƒï¼Œå¦‚æœè¦å˜æ›´åˆ°zhaoolee/pi-k8s-test:002é•œåƒï¼Œåªéœ€æ‰“å¼€kuboardï¼Œæ”¹é•œåƒç‰ˆæœ¬å³å¯ã€‚

![æ›´æ–°é•œåƒ](https://cdn.fangyuanxiaozhan.com/assets/1641393779960mS1xHxrd.png)

k8sé›†ç¾¤ä¼šè‡ªåŠ¨æ‹‰å–é•œåƒï¼Œå®Œæˆæ›´æ–°

- å†…å®¹æ›´æ–°æˆåŠŸ


![æ›´æ–°æˆåŠŸ](https://cdn.fangyuanxiaozhan.com/assets/1641393780302WnGfD7y5.png)



## å°†æ ‘è“æ´¾æœåŠ¡ç©¿é€åˆ°å¤–ç½‘



é€šè¿‡å‰å‡ æ­¥çš„å‡†å¤‡ï¼Œæˆ‘ä»¬å·²ç»å°† 192.168.50.240 åšä¸ºæˆ‘ä»¬çš„k8sé›†ç¾¤å…¥å£ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åªéœ€é€šè¿‡frpå°† 192.168.50.240 ç©¿é€åˆ°å…¬ç½‘çš„k8s.v2fy.comï¼Œ å³å¯å®ç°å¤–ç½‘è®¿é—®æ ‘è“æ´¾é›†ç¾¤æä¾›çš„æœåŠ¡



- æœ€ç»ˆæ•ˆæœå±•ç¤º

  

  

  ![k8s.v2fy.com](https://cdn.fangyuanxiaozhan.com/assets/1641470734371r4Ka16Sk.png)

192.168.50.10è´Ÿè´£è¿è¡Œmaster, å¹¶ä¸èƒ½è®¿é—®æˆ‘ä»¬çš„è´Ÿè½½å‡è¡¡ip 192.168.50.240, è€Œnode1(192.168.50.20)èŠ‚ç‚¹å’Œnode2(192.168.50.20)èŠ‚ç‚¹æ‰€åœ¨çš„æœºå™¨å¯ä»¥é¡ºåˆ©è®¿é—®è´Ÿè½½å‡è¡¡ip





æˆ‘ä»¬é€‰æ‹©åœ¨node1èŠ‚ç‚¹æ‰€åœ¨çš„æ ‘è“æ´¾ä¸Šï¼Œå¼€å¯frpå®¢æˆ·ç«¯æœåŠ¡



- `frpc.ini`é…ç½®æ–‡ä»¶



```
[common]
server_addr = 120.76.136.220
server_port = 7000
token = '********'
log_file = './frpc.log'

[pi-k8s]
type = tcp
local_ip = 192.168.50.240
local_port = 80
remote_port = 9666
```

é…ç½®æ–‡ä»¶çš„ä½œç”¨æ˜¯ï¼Œå°†å†…ç½‘`192.168.50.240:80`  ç©¿é€åˆ°å…¬ç½‘`120.76.136.220:9666`



frpå®‰è£…ä½¿ç”¨æ•™ç¨‹è¯·å‚è€ƒ [ã€Šæ ‘è“æ´¾å®¶åº­æœåŠ¡å™¨æ­å»ºæŒ‡å—ã€‹åˆ·Ubuntu Server 20.04ï¼Œç»‘å®šå…¬ç½‘åŸŸåï¼Œå¯¹å…¬ç½‘æä¾›httpæœåŠ¡ï¼ŒSSHç™»å½•æœåŠ¡ https://v2fy.com/p/2021-10-01-pi-server-1633066843000/](https://v2fy.com/p/2021-10-01-pi-server-1633066843000/)



- å°†è‡ªå·±çš„åŸŸåï¼Œï¼ˆæ¯”å¦‚k8s.v2fy.comï¼‰ ï¼Œè§£æåˆ°å…¬ç½‘æœåŠ¡å™¨ip ï¼ˆæ¯”å¦‚120.76.136.220ï¼‰



ç„¶åé€šè¿‡å…¬ç½‘æœåŠ¡å™¨Nginxï¼Œä»£ç†k8s.v2fy.com, å°†æŒ‡å‘k8s.v2fy.com 80ç«¯å£å’Œ443ç«¯å£çš„è¯·æ±‚ï¼Œå…¨éƒ¨è½¬å‘åˆ°9666ç«¯å£



Nginxå‚è€ƒé…ç½®æ–‡ä»¶ `/etc/nginx/conf.d/k8s.v2fy.com.conf`



```
upstream k8s_v2fy_com { server 127.0.0.1:9666; }

server {
    server_name      k8s.v2fy.com;
    listen       80;
    listen       [::]:80;
    rewrite ^(.*)$ https://$host$1 permanent;
}


server {
    listen       443 ssl http2;
    listen       [::]:443 ssl http2;
    server_name  k8s.v2fy.com;

    location / {
        proxy_pass http://k8s_v2fy_com;
        proxy_set_header Host $host:443;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    ssl_certificate "/etc/nginx/ssl/k8s.v2fy.com/fullchain.cer";
    ssl_certificate_key "/etc/nginx/ssl/k8s.v2fy.com/k8s.v2fy.com.key";
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout  10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Load configuration files for the default server block.
    include /etc/nginx/default.d/*.conf;

    error_page 404 /404.html;
        location = /40x.html {
    }

    error_page 500 502 503 504 /50x.html;
        location = /50x.html {
    }
}
```



- å¦‚ä½•è·å–è‡ªåŠ¨ç»­æœŸçš„httpsè¯ä¹¦ï¼Ÿ

è¯·å‚è€ƒ [é›¶ä¾èµ–!ä½¿ç”¨acme.shè®¾ç½®nginxå¤šä¸ªhttpsè¯ä¹¦è‡ªåŠ¨æ›´æ–°ï¼Œæ— é™ç»­æœŸhttpsè¯ä¹¦ https://v2fy.com/p/2021-06-27-nginx-https-1624774964000/](https://v2fy.com/p/2021-06-27-nginx-https-1624774964000/)



å®‰è£…è¯ä¹¦å®Œæˆåï¼Œè®°å¾—é‡å¯Nginx



```
sudo nginx -t
sudo systemctl restart nginx
```

- æœ€åæˆ‘ä»¬å¯ä»¥é€šè¿‡https://k8s.v2fy.com è®¿é—®åˆ°æˆ‘ä»¬å†…ç½‘k8sçš„æœåŠ¡äº†



![å°åŠ¨ç‰©å›¾ç‰‡](https://cdn.fangyuanxiaozhan.com/assets/1641473987496kAiK80HC.png)

![æ¤…å­](https://cdn.fangyuanxiaozhan.com/assets/1641474036704Q1EWpXyb.png)



![å†¬æ—¥](https://cdn.fangyuanxiaozhan.com/assets/1641474411824eYeN8Aa5.png)


## å°ç»“

å¦‚æœä½ åªæ˜¯æƒ³å­¦ä¹ k8sæŠ€æœ¯ï¼Œè€Œä¸æ˜¯æ­å»ºé›†ç¾¤ï¼Œå®Œå…¨å¯ä»¥ç”¨minikubeæ¥å­¦ä¹ , Ubuntu20.04è¯•æ°´k8så•æœºç‰ˆminikubeéƒ¨ç½²å®å½• https://v2fy.com/p/2021-07-26-k8s-1627292526000/

æˆ‘ä»2022å¹´å…ƒæ—¦å¼€å§‹ï¼Œä¾¿å¼€å§‹æŠ˜è…¾æ ‘è“æ´¾è£¸æœºæ­å»ºk8sï¼Œæ—¶è‡³å‘æ–‡ï¼Œå·²æœ‰5å¤©ã€‚k8sç¡®å®æ˜¯è¯±äººçš„æŠ€æœ¯ï¼ŒæŠ€æœ¯çˆ±å¥½è€…ç»è¿‡å‡ å¤©çš„å­¦ä¹ ï¼Œä¾¿èƒ½é¡ºåˆ©æ­å»ºè‡ªå·±çš„é›†ç¾¤ï¼Œå¹¶è·‘èµ·è‡ªå»ºçš„æœåŠ¡ã€‚k8sé›†ç¾¤è®¾è®¡çš„æ€æƒ³ï¼Œä¹Ÿç¡®å®ç§°å¾—ä¸Šæå¥½çš„æ•™æï¼Œé€šè¿‡å±‚å±‚æŠ½è±¡åˆ†ç¦»ï¼Œè®©å„ç§æœåŠ¡podçš„è°ƒåº¦å˜å¾—æ˜ç¡®ï¼Œæ’æŸ¥é—®é¢˜ä¹Ÿå˜å¾—ç®€å•ï¼ŒåŒæ—¶è®©ä¼—å¤šæœåŠ¡çš„ç®¡ç†å˜å¾—ç®€å•ã€‚

2022å¹´, æŠ•æœºè€…ä¾ç„¶æƒ³ç€å‘å„ç§å¸æ¥å‰²éŸ­èœ, æŒ–çŸ¿æ¶ˆè€—äº†å¤§é‡ç”µåŠ›, åªæ˜¯ä¸ºäº†ç®—ä¸€ä¸ªæ— æ„ä¹‰çš„å­—ç¬¦ä¸², å³ä½¿ä¸æ‡‚è®¡ç®—æœºçš„äºº, å–Šä¸¤å¥åˆ†å¸ƒå¼, å°±èƒ½æˆä¸ºä¸€ååˆæ ¼çš„éŸ­èœ, ç”Ÿç”Ÿä¸æ¯, çœŸæ­£é€šè¿‡åˆ†å¸ƒå¼ç®¡ç†æœåŠ¡å™¨é›†ç¾¤çš„k8sç³»ç»Ÿå´æ— äººé—®æ´¥, æ¯•ç«Ÿæä¾›ç¨³å®šçš„ç³»ç»Ÿäº§ç”Ÿçš„ä»·å€¼æ— æ³•è¢«å¤§å¤šæ•°äººç†è§£, è‘—åè‰ºæœ¯å®¶å­™å®‡æ™¨è€å¸ˆæ‹¿ç€ç¥–ä¼ 100ä¸‡åˆ°å¤„ç‚’çƒ­åº¦, è¹­çƒ­ç‚¹è¿œæ¯”ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿçš„äººæ¥é’±å¿«, ä½†èƒ½æå‡ç”Ÿäº§åŠ›çš„k8sæŠ€æœ¯, å­¦å¾—å¥½, ä¸ç”¨åå¤æ¨ªè·³, ä¹Ÿèƒ½å–ä¸ªå¥½ä»·é’±, å³ä½¿æ˜¯æŒ–çŸ¿, ç”¨k8sé›†ç¾¤æ‰¹é‡ç®¡ç†æŒ–çŸ¿ä¸»æœºçš„äºº, ä¹Ÿèƒ½å¯¹é‚£äº›å¼€ç€Nå°WindowsæŒ–çŸ¿çš„äººå½¢æˆé™ç»´æ‰“å‡»ã€‚



